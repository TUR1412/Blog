# 变更提案: capstone-delivery（封顶交付）

## 需求背景
当前项目已具备稳定的“洞天”信息架构、主题系统、站内 Overlay（Toast/Confirm）与基础自动化测试门禁（Vitest + Playwright），整体手感已接近可长期维护的状态。

本轮目标不是“再做一轮小优化”，而是以一次性交付为导向，把产品体验、可访问性、性能自证、测试/CI 可观测性与文档 SSOT 统一抬到行业标杆水平，并将验收标准固化为自动化门禁，避免后续回归。

## 产品分析

### 目标用户与场景
- **用户群体:** 读者（浏览与回访）、维护者（内容更新与体验迭代）、重度使用者（札记/收藏/批注本地长期沉淀）
- **使用场景:**
  - 移动端碎片阅读：快速跳转、无障碍可读、不卡顿
  - 桌面端深度对照：关系谱/洞府图/批注馆多视图切换、键盘操作与搜索直达
  - 写与回访：札记与收藏“落笔不丢”，导入导出可复原
- **核心痛点:**
  - UI/交互细节一旦回归，靠肉眼很难及时发现（需要可观测与门禁）
  - 弹层/菜单/命令面板的可访问性与键盘体验需要统一的工程化保障
  - 性能与包体积缺少预算线，容易在功能扩展中悄然膨胀

### 价值主张与成功指标
- **价值主张:** “观感与手感同等锋利”——读起来顺、找起来快、写下来稳、回访不丢；且可持续维护、不怕回归。
- **成功指标（可自动验收）:**
  - `npm run lint` / `npm run test:ci` / `npm run build` / `npm run test:e2e` 全绿
  - e2e 覆盖关键链路：导航、主题、危险 Confirm、札记持久化、命令面板基础可用
  - a11y 自动扫描：关键页面/弹层无 critical/serious 级别问题（门禁）
  - 产物体积预算：关键 bundle/主入口 gzip 体积不超过预算（门禁）
  - CI 失败可快速定位：Playwright 失败保留截图/视频/trace，并上传工件

### 人文关怀
- 尊重不同设备与能力：`prefers-reduced-motion` 下动效降级，避免眩晕与注意力负担。
- 尊重隐私：保持本地优先，不引入云端追踪；导入导出仅在本地处理。
- 尊重维护者：把“好体验”固化为门禁与SSOT，减少口口相传与隐性知识。

## 变更内容
1. UI/UX：设计系统与关键交互细节的封顶级打磨（响应式、微交互、可读性、一致性）。
2. A11y：为导航/弹层/命令面板建立可访问性门禁（自动扫描 + 关键键盘路径测试）。
3. 性能与可观测：建立包体积预算线与构建产物自证；优化动效与高成本效果的降级策略。
4. 质量与CI：扩展 e2e 覆盖与失败工件策略；补齐关键工具函数的单测覆盖。
5. 文档与SSOT：更新 README 与 `helloagents/` 知识库，使架构、门禁与运行方式可复现。

## 影响范围
- **模块:** app / components / providers / routes / lib / pages
- **文件:** `src/**`、`e2e/**`、`package.json`、`.github/workflows/*`、`helloagents/**`
- **API:** 无服务端 API；涉及“URL/导入导出接口文档”与本地存储键的约定更新
- **数据:** localStorage/sessionStorage（仅新增/规范化，不做破坏性迁移）

## 核心场景

### 需求: UI/UX 封顶（跨端一致 + 微交互）
**模块:** components / pages / providers

#### 场景: 移动端阅读与导航不遮挡、不溢出
- 顶部固定导航在小屏下不遮挡标题与关键操作
- 关键列表/长表格在窄屏下可横向滚动且不破版

#### 场景: 弹层/菜单/命令面板交互一致
- 打开时焦点落在合理控件；ESC/点击遮罩可关闭；焦点不会“逃逸”到背景
- 视觉与动效一致，且在 reduced-motion 下自动降级

### 需求: 可访问性门禁（A11y Gate）
**模块:** providers / components / e2e

#### 场景: 关键页面无严重可访问性问题
- 自动化 a11y 扫描无 serious/critical
- 语义结构完整（header/nav/main/footer），可聚焦元素有清晰 focus-ring

### 需求: 性能预算与自证（Performance Budget）
**模块:** build / scripts / CI

#### 场景: 产物体积不在迭代中失控
- 关键入口与大块 chunk 体积有预算线
- 超预算时 CI 明确报错并提示定位方式

### 需求: 测试与CI 可观测性（Quality Gate）
**模块:** e2e / CI

#### 场景: 回归可被自动发现、失败可被快速定位
- e2e 覆盖关键链路且稳定
- Playwright 失败可直接查看报告/trace/视频/截图

## 风险评估
- **风险:** a11y 扫描引入新依赖导致 CI 变慢或不稳定
  - **缓解:** 仅扫描少量关键页面；按 `CI` 环境配置 reporter 与工件；必要时分组并行
- **风险:** 体积预算过严导致频繁红灯
  - **缓解:** 首次以“宽松但有意义”的预算落地；后续再逐步收紧
- **风险:** UI/交互重构影响边角路径
  - **缓解:** 以 e2e + 单测覆盖关键路径；改动优先集中在基础组件与框架层

